{% load staticfiles %}
<!DOCTYPE HTML>
<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
        <title>TEST2</title>
        {% include 'main/include/general_css.html' %}
        {% include 'main/include/general_script.html' %}
        <style>

        </style>
        <script>
            $(function () {
                window.$csrf_input = $('input[name="csrfmiddlewaretoken"]');
                getList("{% url 'variable_group_select_json' %}", window.$csrf_input.val(), update_config_dropdown, "{selected_pk:1}");



                var chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/');

                chatSocket.onmessage = function(e) {
                    var data = JSON.parse(e.data);
                    var message = data['message'];
                    document.querySelector('#chat-log').value += (message + '\n');
                };

                chatSocket.onclose = function(e) {
                    console.error('Chat socket: ', e);
                };

                document.querySelector('#chat-message-input').focus();
                document.querySelector('#chat-message-input').onkeyup = function(e) {
                    if (e.keyCode === 13) {  // enter, return
                        document.querySelector('#chat-message-submit').click();
                    }
                };

                document.querySelector('#chat-message-submit').onclick = function(e) {
                    var messageInputDom = document.querySelector('#chat-message-input');
                    var message = messageInputDom.value;
                    chatSocket.send(JSON.stringify({
                        'message': message
                    }));

                    messageInputDom.value = '';
                };



                $('#suite-submit').off('click').on('click', function () {
                    var suite_pk = $('#suite-input').val();
                    var suite_socket = new WebSocket('ws://' + window.location.host + '/ws/suite_execute/' + String(suite_pk));
                    var chat_log = $('#chat-log');
                    chat_log.val('');
                    var log = '';
                    suite_socket.onmessage = function(data) {
                        var message = JSON.parse(data.data)['message'];
                        log += message + '\n';
                        chat_log.val(log);
                        chat_log.scrollTop(chat_log.get(0).scrollHeight);
                    };
                    suite_socket.onclose = function(e) {
                        var message = 'end' + '\n';
                        log = chat_log.val() + message;
                        chat_log.val(log);
                        chat_log.scrollTop(chat_log.get(0).scrollHeight);
                    };

                })


            });


            function update_config_dropdown(success, data) {
                var base_div = $("#div_base1");
                base_div.find("div#div_dropdown1").remove();
                var div_dropdown = $('<div id="div_dropdown1"><select id="select1" style="display:none" placeholder="请选择"></select></div>');
                base_div.append(div_dropdown);
                $("#div_dropdown1").j_dropdown({
                    data: data.data,
                    //multipleMode: 'label',
                    //limitCount: 1,
                    input: '<input type="text" maxLength="20" placeholder="请输入名称搜索">',
                    choice: function() {
                        console.log(this.selectId);
                        window._selectId1 = this.selectId;
                        //window._selectId = JSON.stringify(this.selectId);
                    }
                });
            }
        </script>
    </head>
    <body>
        {% csrf_token %}
        <div id="div_base1"></div>

        <br>
        <textarea id="chat-log" cols="100" rows="10" readonly class="form-control"></textarea><br/>
        <input id="chat-message-input" type="text" size="100"/>
        <input id="chat-message-submit" type="button" value="Send"/>
        <br>
        <br>
        <input id="suite-input" type="text" size="100" value="12"/>
        <input id="suite-submit" type="button" value="Run"/>

    </body>
</html>